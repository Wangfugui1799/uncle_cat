## 问题分析

当前提示词中使用 `{short_summary}` 表示当前章节摘要，但实际上应该使用状态存档中的 `chapterSummary`，且变量名与来源不匹配，容易造成混淆。

## 解决方案

直接使用 `chapter_summary` 作为变量名，替换当前的 `short_summary`，并确保它指向状态存档的 `chapterSummary`。

## 具体实现步骤

### 1. 修改提示词模板（constants.ts）

将提示词中的 `{short_summary}` 改为 `{chapter_summary}`：

```diff
**前文基础**：
- 全局摘要：{global_summary}
- 前章结尾：{previous_chapter_excerpt}
- 角色状态：{character_state}
- 当前章节摘要：{short_summary}
+ 当前章节摘要：{chapter_summary}
```

### 2. 修改 `handleGenerateChapter` 函数

将 `short_summary` 替换为 `chapter_summary`，并指向 `latestArchive.chapterSummary`：

```diff
const variables = {
    // 其他变量保持不变
    global_summary: latestArchive.globalSummary,
    previous_chapter_excerpt: previousContent,
-   short_summary: params.summary || "暂无摘要",
+   chapter_summary: latestArchive.chapterSummary || "暂无摘要",
    next_chapter_number: chapterNum + 1,
    // 其他变量保持不变
};
```

### 3. 修改 `generateFullPrompt` 函数

同样将 `short_summary` 替换为 `chapter_summary`，并指向 `latestArchive.chapterSummary`：

```diff
variables = {
    // 其他变量保持不变
    global_summary: latestArchive.globalSummary,
    previous_chapter_excerpt: previousContent,
-   short_summary: shortSummary,
+   chapter_summary: latestArchive.chapterSummary || "暂无摘要",
    next_chapter_number: currentChapterNum + 1,
    // 其他变量保持不变
};
```

## 修改后效果

修改后，提示词将使用 `{chapter_summary}`，从字面上就能看出：
- 这是章节摘要
- 与存档中的 `chapterSummary` 对应，名称一致

这样变量名直接反映了其内容和来源，避免了混淆，同时实现了您期望的效果：写第四章时引用第三章的本章摘要。
## 修改章节生成逻辑以自动使用状态存档

### 问题分析
当前系统中，章节生成时使用的是全局的 `generatedData.state` 和 `generatedData.globalSummary`，而不是自动使用前一章的状态存档。这导致如果用户忘记点击"状态更新"按钮，生成的章节可能使用的是过时的角色状态和全局摘要。

### 解决方案
修改章节生成逻辑，使其根据当前章节号自动查找并使用合适的状态存档：

1. **添加状态存档查找函数**：创建一个函数，根据当前章节号查找最合适的状态存档
2. **修改章节生成函数**：在 `handleGenerateChapter` 和 `generateFullPrompt` 中使用该函数获取正确的状态
3. **确保状态一致性**：确保两个函数使用相同的状态查找逻辑

### 具体实现步骤

#### 1. 添加状态存档查找函数
```typescript
// 查找最合适的状态存档
const findLatestStateArchive = (targetChapterNum: number) => {
    // 对于第1章，直接使用初始状态
    if (targetChapterNum === 1) {
        return {
            characterState: generatedData.state || "暂无角色状态",
            globalSummary: generatedData.globalSummary || generatedData.dna || "暂无全局摘要",
            chapterSummary: "暂无章节摘要"
        };
    }
    
    // 对于后续章节，查找最大的章节号 ≤ targetChapterNum - 1 的存档
    const sortedArchives = [...(generatedData.stateHistory || [])].sort((a, b) => b.chapterNum - a.chapterNum);
    
    // 查找第一个章节号小于 targetChapterNum 的存档
    const latestArchive = sortedArchives.find(archive => archive.chapterNum < targetChapterNum);
    
    // 如果找到存档，使用存档中的状态；否则使用当前全局状态
    if (latestArchive) {
        return {
            characterState: latestArchive.characterState,
            globalSummary: latestArchive.globalSummary,
            chapterSummary: latestArchive.chapterSummary
        };
    }
    
    // 没有找到存档，使用当前全局状态
    return {
        characterState: generatedData.state || "暂无角色状态",
        globalSummary: generatedData.globalSummary || generatedData.dna || "暂无全局摘要",
        chapterSummary: "暂无章节摘要"
    };
};
```

#### 2. 修改 handleGenerateChapter 函数
- 在生成章节前调用 `findLatestStateArchive` 函数获取正确的状态
- 使用存档中的 `globalSummary` 和 `characterState` 替代全局变量

#### 3. 修改 generateFullPrompt 函数
- 在生成完整提示词前调用 `findLatestStateArchive` 函数获取正确的状态
- 使用存档中的状态替代全局变量

### 预期效果
- 第1章生成时：使用初始状态
- 第2章生成时：使用第1章的状态存档
- 第3章生成时：使用第2章的状态存档
- 依此类推...
- 如果用户没有为第N章更新状态，生成第N+1章时会使用第N-1章的状态存档

### 技术要点
- 使用 `stateHistory` 数组按章节号排序，方便查找
- 实现灵活的存档查找逻辑，确保总能找到合适的状态
- 保持与现有代码结构的兼容性
- 确保修改后的代码易于理解和维护

### 文件修改清单
- `App.tsx`：添加状态存档查找函数，修改章节生成和完整提示词生成逻辑

这个修改将确保章节生成时始终使用最合适的状态存档，提高生成内容的连贯性和一致性，同时减少用户操作负担。
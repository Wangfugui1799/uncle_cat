## 问题分析

当前提示词模板中存在变量名冲突：

1. **`{chapter_summary}` 被用于两个不同的地方**：
   - 前文基础部分：`- 当前章节摘要：{chapter_summary}`
   - 当前章节规划部分：`- 本章简述：{chapter_summary}`

2. **但这两个地方应该使用不同的内容**：
   - 前文基础部分：应该使用前一章存档的 `chapterSummary`（已实现）
   - 当前章节规划部分：应该使用当前章节蓝图的 `**本章简述：**` 部分

3. **导致的问题**：
   - 两个不同的内容使用了相同的变量名，造成混淆
   - 违反了变量名应该直观反映其来源的原则

## 解决方案

将当前章节规划部分的 `{chapter_summary}` 改回 `{short_summary}`，同时在代码中保留 `short_summary` 变量，用于存储从章节蓝图提取的本章简述。

## 具体实现步骤

### 1. 修改提示词模板（constants.ts）

将当前章节规划部分的 `{chapter_summary}` 改回 `{short_summary}`：

```diff
**当前章节规划**：
- 第{novel_number}章《{chapter_title}》
- 本章定位：{chapter_role}
- 核心作用：{chapter_purpose}
- 悬念密度：{suspense_level}
- 伏笔操作：{foreshadowing}
- 认知颠覆：{plot_twist_level}
- 本章简述：{chapter_summary}
+ 本章简述：{short_summary}
```

### 2. 修改代码中的变量映射

在 `handleGenerateChapter` 和 `generateFullPrompt` 函数中，添加 `short_summary` 变量，用于存储从章节蓝图或当前章节提取的本章简述。

#### 2.1 修改 `handleGenerateChapter` 函数

```diff
const variables = {
    // 其他变量保持不变
    global_summary: latestArchive.globalSummary,
    previous_chapter_excerpt: previousContent,
    chapter_summary: latestArchive.chapterSummary || "暂无摘要", // 来自前一章存档
+   short_summary: params.summary || "暂无摘要", // 来自当前章节
    next_chapter_number: chapterNum + 1,
    // 其他变量保持不变
};
```

#### 2.2 修改 `generateFullPrompt` 函数

```diff
variables = {
    // 其他变量保持不变
    global_summary: latestArchive.globalSummary,
    previous_chapter_excerpt: previousContent,
    chapter_summary: latestArchive.chapterSummary || "暂无摘要", // 来自前一章存档
+   short_summary: shortSummary, // 来自当前章节蓝图
    next_chapter_number: currentChapterNum + 1,
    // 其他变量保持不变
};
```

## 修改后效果

修改后，提示词模板将使用不同的变量名区分不同来源的内容：

1. **前文基础部分**：
   - `{global_summary}`：来自前一章存档的全局摘要
   - `{character_state}`：来自前一章存档的角色状态
   - `{chapter_summary}`：来自前一章存档的章节摘要

2. **当前章节规划部分**：
   - `{short_summary}`：来自当前章节蓝图的本章简述

这样变量名就直观反映了其来源，避免了冲突，同时保持了代码的清晰性和可读性。
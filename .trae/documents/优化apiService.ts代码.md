**问题分析**：
在检查apiService.ts文件后，我发现了以下可以优化的地方：

1. **代码重复**：generateContent和testConnection函数中有大量重复的代码，如URL构建逻辑、模型类型判断、请求头设置等
2. **错误处理**：可以进一步优化，提供更具体的错误信息
3. **性能**：getMaxTokens函数可以提前计算，避免重复计算
4. **代码结构**：可以将不同模型的处理逻辑分离，提高可读性和可维护性
5. **类型安全**：可以添加更多的类型检查

**优化方案**：

1. **提取公共函数**：

   * 提取URL构建逻辑为单独函数

   * 提取模型类型判断为单独函数

   * 提取请求头设置为单独函数

2. **优化错误处理**：

   * 添加更具体的错误信息

   * 统一错误处理逻辑

3. **性能优化**：

   * 提前计算getMaxTokens

   * 优化重试逻辑

4. **代码结构优化**：

   * 使用配置对象管理不同模型的参数

   * 分离不同模型的处理逻辑

5. **类型安全优化**：

   * 添加更多的类型检查

   * 使用TypeScript类型保护

**修改点**：

* 文件：`services/apiService.ts`

* 函数：`generateContent`、`testConnection`

* 内容：

  * 提取公共函数

  * 优化错误处理

  * 性能优化

  * 代码结构优化

  * 类型安全优化

**预期效果**：

* 减少代码重复，提高可维护性

* 提供更具体的错误信息

* 提高性能

* 提高代码可读性

* 增强类型安全性

**具体实现**：

1. 提取公共函数：

   * buildApiUrl：构建API请求URL

   * getModelType：判断模型类型

   * buildHeaders：构建请求头

   * buildRequestBody：构建请求体

2. 优化错误处理：

   * 统一错误处理逻辑

   * 提供更具体的错误信息

   * 添加更多的错误类型判断

3. 性能优化：

   * 提前计算getMaxTokens

   * 优化重试逻辑，使用指数退避算法

4. 代码结构优化：

   * 使用配置对象管理不同模型的参数

   * 分离不同模型的处理逻辑

5. 类型安全优化：

   * 添加更多的类型检查

   * 使用TypeScript类型保护


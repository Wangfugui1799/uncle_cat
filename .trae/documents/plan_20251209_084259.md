# 判官审题流程优化方案 - 支持修改基础设定

## 问题分析

当前判官审题流程存在以下限制：

1. 审题判官只修改核心DNA，无法修改基础设定
2. 选择方案后只重写DNA，不更新基础设定
3. 基础设定与核心DNA的修改不同步

## 优化方案

### 1. 扩展判官功能，支持修改基础设定

* 修改判官提示词模板，让判官能够针对每个方案提供基础设定修改建议

* 允许判官修改的基础设定包括：小说名称、故事基调、结局倾向、叙事视角、预计章节数、每章字数、自定义特殊要求

### 2. 优化方案选择后的处理逻辑

* 修改 `handleSelectJudgeProposal` 函数，同时更新基础设定和核心DNA

* 确保基础设定和核心DNA的修改保持同步

* 保持与原有格式的一致性

### 3. 重新设计提示词模板

* 更新 `PROMPTS.JUDGE` 模板，要求判官为每个方案提供完整的基础设定修改建议

* 确保生成的结果包含明确的基础设定修改内容

* 设计清晰的格式，便于前端解析和应用

## 实现步骤

### 步骤1：更新判官提示词模板

```typescript
// 在 constants.ts 中更新 PROMPTS.JUDGE
PROMPTS.JUDGE = `
Prompt: 网文选题·生死判官 (V3.0 原创特供版)
// ... 现有内容 ...

【原创S级魔改】 (核心任务):
必须提供 3个 截然不同的原创方向。
每个方向必须包含：
1. **【创新手法】**（如：逻辑重构、核心痛点颠覆）
2. **【基础设定修改】**：包含小说名称、故事基调、结局倾向、叙事视角、预计章节数、每章字数、自定义特殊要求的具体修改建议
3. **【核心DNA重写建议】**：针对当前核心DNA的具体重写建议
4. **原创书名**：必须是市场上未出现过的组合
5. **黄金开篇**：描述前三章的具体情节，必须包含一个反直觉的钩子

// ... 现有内容 ...
`;
```

### 步骤2：修改方案选择处理逻辑

```typescript
const handleSelectJudgeProposal = async (proposalIndex: number) => {
    if (!judgeResult) return;

    setLoadingMessage(`正在根据方案${proposalIndex}重写基础设定和核心DNA...`);
    setIsGenerating(true);
    try {
        // 使用扩展的PROMPTS.DNA模板，支持同时修改基础设定和核心DNA
        const template = customPrompts['DNA'] || PROMPTS.DNA;
        
        // 构建变量，包含当前基础设定和选定的判官方案
        const variables = {
            novel_title: String(inputs.novelTitle || "未命名"),
            topic: String(inputs.topic || ""),
            genre: String(inputs.genre || ""),
            tone: String(inputs.tone || "未指定"),
            ending: String(inputs.ending || "未指定"),
            perspective: String(inputs.perspective || "未指定"),
            number_of_chapters: String(inputs.numberOfChapters || 10),
            word_count: String(inputs.wordCount || 2000),
            custom_requirements: String(inputs.customRequirements || "无"),
            custom_instruction: `根据判官评审方案${proposalIndex}重写基础设定和核心DNA：${judgeResult}`,
            user_guidance: String(inputs.customRequirements || "无")
        };
        
        // 使用formatPrompt函数处理所有变量替换
        const prompt = formatPrompt(template, variables);
        
        // 生成新的基础设定和核心DNA
        const result = await generateContent(prompt, "开始生成任务", apiConfig);
        
        // 解析生成结果，提取基础设定和核心DNA
        // 注意：需要根据实际生成格式调整解析逻辑
        const cleanedResult = cleanCodeBlock(result);
        
        // 更新核心DNA
        setGeneratedData(prev => ({ ...prev, dna: cleanedResult }));
        
        // TODO: 解析生成结果中的基础设定修改建议，并更新inputs状态
        // 这需要根据实际生成格式设计解析逻辑
        // 例如：从生成结果中提取小说名称、故事基调等信息并更新
        
        alert(`已采纳方案${proposalIndex}并重写基础设定和核心DNA`);
    } catch (error: any) {
        console.error('重写失败:', error);
        alert('重写失败：' + error.message);
    } finally {
        setIsGenerating(false);
    }
};
```

### 步骤3：添加结果解析逻辑

* 设计解析函数，从判官的生成结果中提取基础设定修改建议

* 解析逻辑需要处理不同格式的输出，确保可靠性

* 更新 `inputs` 状态，应用基础设定修改

### 步骤4：更新DNA生成模板

* 修改 `PROMPTS.DNA` 模板，支持同时生成基础设定和核心DNA

* 确保输出格式清晰，便于解析

* 保持与原有格式的兼容性

## 预期效果

1. **更强大的判官功能**：判官不仅能修改核心DNA，还能修改基础设定

2. **同步更新**：选择方案后，基础设定和核心DNA同时更新

3. **格式一致**：重写后的内容格式与原格式完全一致

4. **更好的用户体验**：用户获得更全面的修改建议和更完整的重写结果

## 实现注意事项

1. 提示词模板的设计要清晰，便于AI理解和生成结构化输出

2. 结果解析逻辑要健壮，能处理不同格式的输出

3. 确保基础设定和核心DNA的修改保持同步

4. 保持与原有代码的兼容性

5. 完善错误处理机制

## 测试计划

1. 测试判官是否能生成包含基础设定修改建议的结果

2. 测试选择方案后，基础设定和核心DNA是否同时更新

3. 测试不同方案选择后的结果是否符合预期

4. 测试错误处理机制是否正常工作

5. 测试输出格式是否与原格式一致


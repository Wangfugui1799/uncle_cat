<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepStory API 配置诊断工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f0f0f; color: #e0e0e0; font-family: 'Segoe UI', system-ui, sans-serif; }
        .diagnostic-card { background: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 20px; margin: 10px 0; }
        .status-good { color: #10b981; border-left: 4px solid #10b981; }
        .status-bad { color: #ef4444; border-left: 4px solid #ef4444; }
        .status-warning { color: #f59e0b; border-left: 4px solid #f59e0b; }
        .test-btn { background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; }
        .test-btn:hover { background: #2563eb; }
        .test-btn:disabled { background: #6b7280; cursor: not-allowed; }
    </style>
</head>
<body class="p-6 max-w-4xl mx-auto">
    <h1 class="text-2xl font-bold mb-6 text-orange-400">DeepStory API 配置诊断工具</h1>
    
    <div class="diagnostic-card">
        <h2 class="text-lg font-semibold mb-4">1. 当前API配置状态</h2>
        <div id="config-status">正在检查配置...</div>
    </div>

    <div class="diagnostic-card">
        <h2 class="text-lg font-semibold mb-4">2. 连接测试</h2>
        <button id="test-connection" class="test-btn">测试API连接</button>
        <div id="test-result" class="mt-4"></div>
    </div>

    <div class="diagnostic-card">
        <h2 class="text-lg font-semibold mb-4">3. 手动配置检查</h2>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium mb-2">API提供商:</label>
                <select id="provider-select" class="w-full bg-stone-800 border border-stone-600 rounded p-2 text-white">
                    <option value="gemini">Google Gemini</option>
                    <option value="openai">OpenAI</option>
                    <option value="claude">Anthropic Claude</option>
                    <option value="deepseek">DeepSeek</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">API密钥:</label>
                <input type="text" id="api-key-input" class="w-full bg-stone-800 border border-stone-600 rounded p-2 text-white" placeholder="输入您的API密钥">
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">基本网址:</label>
                <input type="text" id="base-url-input" class="w-full bg-stone-800 border border-stone-600 rounded p-2 text-white" placeholder="https://generativelanguage.googleapis.com">
            </div>
            <button id="manual-test" class="test-btn">手动测试连接</button>
        </div>
    </div>

    <div class="diagnostic-card">
        <h2 class="text-lg font-semibold mb-4">4. 常见问题排查</h2>
        <ul class="space-y-2 text-sm">
            <li>• API密钥格式错误 - 检查密钥是否以正确的格式开头</li>
            <li>• 网络连接问题 - 确保可以访问API服务商网站</li>
            <li>• 模型选择不当 - 确保选择了支持的模型</li>
            <li>• 配额不足 - 检查API密钥是否有足够的额度</li>
            <li>• 区域限制 - 某些API可能需要特定区域的网络</li>
        </ul>
    </div>

    <script>
        // 检查当前配置状态
        function checkConfigStatus() {
            try {
                const configStr = localStorage.getItem('deepstory-api-config');
                const config = configStr ? JSON.parse(configStr) : null;
                
                const statusDiv = document.getElementById('config-status');
                
                if (!config || !config.apiKey || config.apiKey === 'PLACEHOLDER_API_KEY') {
                    statusDiv.innerHTML = `
                        <div class="status-bad">
                            <p>❌ API配置未设置或使用占位符</p>
                            <p class="text-sm mt-2">当前配置: ${configStr || '未找到配置'}</p>
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <div class="status-good">
                            <p>✅ API配置已设置</p>
                            <div class="text-sm mt-2 bg-stone-800 p-3 rounded">
                                <p><strong>提供商:</strong> ${config.provider || '未指定'}</p>
                                <p><strong>基本网址:</strong> ${config.baseUrl || '默认'}</p>
                                <p><strong>模型:</strong> ${config.textModel || '默认'}</p>
                                <p><strong>API密钥:</strong> ${config.apiKey.substring(0, 10)}...${config.apiKey.substring(config.apiKey.length - 4)}</p>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('config-status').innerHTML = `
                    <div class="status-bad">
                        <p>❌ 检查配置时出错: ${error.message}</p>
                    </div>
                `;
            }
        }

        // 测试API连接
        async function testConnection(config) {
            const resultDiv = document.getElementById('test-result');
            const testBtn = document.getElementById('test-connection');
            
            testBtn.disabled = true;
            testBtn.textContent = '测试中...';
            resultDiv.innerHTML = '<p class="text-yellow-400">正在测试连接...</p>';
            
            try {
                const testSystemPrompt = "You are a helpful assistant. Please respond with 'OK' if you can understand this message.";
                const testUserPrompt = "Test connection";

                const apiKeyToUse = config.apiKey?.trim() || "";
                const baseUrl = config.baseUrl?.trim() || "https://generativelanguage.googleapis.com";
                const textModel = config.textModel === 'custom' ? config.customTextModel || 'gpt-4o' : (config.textModel?.trim() || "gemini-2.5-flash");

                const isGemini = baseUrl.includes('generativelanguage.googleapis.com');
                const isClaude = baseUrl.includes('anthropic.com') || config.provider === 'claude';
                let url = '';

                if (isGemini) {
                    url = `${baseUrl}/v1beta/models/${textModel}:generateContent?key=${apiKeyToUse}`;
                } else if (isClaude) {
                    let cleanBase = baseUrl.replace(/\/+$/, '');
                    if (cleanBase.endsWith('/v1/messages')) {
                        url = cleanBase;
                    } else if (cleanBase.endsWith('/v1')) {
                        url = `${cleanBase}/messages`;
                    } else {
                        url = `${cleanBase}/v1/messages`;
                    }
                } else {
                    let cleanBase = baseUrl.replace(/\/+$/, '');
                    if (cleanBase.endsWith('/chat/completions')) {
                        url = cleanBase;
                    } else if (cleanBase.endsWith('/v1')) {
                        url = `${cleanBase}/chat/completions`;
                    } else {
                        url = `${cleanBase}/v1/chat/completions`;
                    }
                }

                let body = {};
                let headers = { 'Content-Type': 'application/json' };

                if (isGemini) {
                    body = {
                        contents: [{ parts: [{ text: testUserPrompt }] }],
                        systemInstruction: { parts: [{ text: testSystemPrompt }] },
                        generationConfig: { maxOutputTokens: 10, temperature: 0.0 }
                    };
                } else if (isClaude) {
                    body = {
                        model: textModel,
                        max_tokens: 10,
                        temperature: 0.0,
                        messages: [
                            { role: "system", content: testSystemPrompt },
                            { role: "user", content: testUserPrompt }
                        ]
                    };
                    headers['Authorization'] = `Bearer ${apiKeyToUse}`;
                    headers['x-api-key'] = apiKeyToUse;
                } else {
                    body = {
                        model: textModel,
                        max_tokens: 10,
                        temperature: 0.0,
                        messages: [
                            { role: "system", content: testSystemPrompt },
                            { role: "user", content: testUserPrompt }
                        ]
                    };
                    headers['Authorization'] = `Bearer ${apiKeyToUse}`;
                }

                const response = await fetch(url, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(body),
                    signal: AbortSignal.timeout(10000)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                
                resultDiv.innerHTML = `
                    <div class="status-good">
                        <p>✅ 连接成功！API服务正常</p>
                        <p class="text-sm mt-2">响应时间: ${response.headers.get('date') || '未知'}</p>
                        <p class="text-sm">状态码: ${response.status}</p>
                    </div>
                `;
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="status-bad">
                        <p>❌ 连接失败</p>
                        <p class="text-sm mt-2">错误信息: ${error.message}</p>
                        <p class="text-xs mt-1 text-stone-400">请检查API密钥、网络连接和配置设置</p>
                    </div>
                `;
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = '测试API连接';
            }
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            checkConfigStatus();
            
            // 自动测试按钮
            document.getElementById('test-connection').addEventListener('click', async function() {
                const configStr = localStorage.getItem('deepstory-api-config');
                const config = configStr ? JSON.parse(configStr) : null;
                
                if (!config || !config.apiKey || config.apiKey === 'PLACEHOLDER_API_KEY') {
                    alert('请先在DeepStory应用中配置API密钥');
                    return;
                }
                
                await testConnection(config);
            });
            
            // 手动测试按钮
            document.getElementById('manual-test').addEventListener('click', async function() {
                const provider = document.getElementById('provider-select').value;
                const apiKey = document.getElementById('api-key-input').value.trim();
                const baseUrl = document.getElementById('base-url-input').value.trim();
                
                if (!apiKey) {
                    alert('请输入API密钥');
                    return;
                }
                
                const config = {
                    provider,
                    apiKey,
                    baseUrl: baseUrl || (provider === 'gemini' ? 'https://generativelanguage.googleapis.com' : 
                              provider === 'openai' ? 'https://api.openai.com' :
                              provider === 'claude' ? 'https://api.anthropic.com' :
                              provider === 'deepseek' ? 'https://api.deepseek.com' : ''),
                    textModel: 'gemini-2.5-flash'
                };
                
                await testConnection(config);
            });
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepStory AI - 智能小说创作工具</title>
    <script src="./node_modules/.vite/deps/react.js"></script>
    <script src="./node_modules/.vite/deps/react-dom.js"></script>
    <script src="./node_modules/.vite/deps/react_jsx-runtime.js"></script>
    <script src="./node_modules/.vite/deps/lucide-react.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Global Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #1c1917;
            border-left: 1px solid #292524;
        }

        ::-webkit-scrollbar-thumb {
            background-color: #57534e;
            border-radius: 5px;
            border: 2px solid #1c1917;
        }

        ::-webkit-scrollbar-thumb:hover {
            background-color: #78716c;
        }

        /* Firefox */
        * {
            scrollbar-width: thin;
            scrollbar-color: #57534e #1c1917;
        }

        /* Custom animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes zoomIn {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .animate-in {
            animation: fadeIn 0.2s ease-out;
        }

        .zoom-in-95 {
            animation: zoomIn 0.2s ease-out;
        }

        /* Custom styles */
        .custom-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: #57534e #1c1917;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1c1917;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #57534e;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: #78716c;
        }

        /* Loading animation */
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #f59e0b;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Markdown viewer styles */
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            color: #fbbf24;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .markdown-content p {
            margin-bottom: 1rem;
            line-height: 1.6;
        }

        .markdown-content code {
            background-color: #374151;
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            font-family: 'Courier New', monospace;
        }

        .markdown-content pre {
            background-color: #1f2937;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 1rem 0;
        }

        .markdown-content pre code {
            background: none;
            padding: 0;
        }
    </style>
</head>
<body class="bg-stone-950 text-stone-300 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        // 常量定义
        const TAGS = {
            male: ['全部', '东方仙侠', '科幻末世', '都市日常', '都市修真', '都市高武', '历史古代', '战神赘婿', '都市种田', '传统玄幻', '历史脑洞', '悬疑脑洞', '都市脑洞', '游戏体育', '抗战谍战', '动漫衍生', '男频衍生'],
            female: ['全部', '现代言情', '古代言情', '年代种田', '悬疑灵异', '玄幻脑洞', '豪门总裁', '宫斗宅斗', '穿越重生', '快穿系统', '种田经商', '仙侠奇缘', '青春校园', '悬疑推理', '动漫衍生']
        };

        const STORY_TONES = [
            { label: '喜剧[欢快]', value: '喜剧' },
            { label: '悲剧[虐心]', value: '悲剧' },
            { label: '正剧[严肃]', value: '正剧' },
            { label: '轻松[休闲]', value: '轻松' },
            { label: '爆笑[搞怪]', value: '爆笑' },
            { label: '暗黑[阴郁]', value: '暗黑' }
        ];

        const ENDING_TYPES = [
            { label: '圆满[喜结]', value: '圆满' },
            { label: '悲剧[遗憾]', value: '悲剧' },
            { label: '开放[余地]', value: '开放' },
            { label: '反转[意外]', value: '反转' },
            { label: '循环[首尾]', value: '循环' },
            { label: '模糊[迷离]', value: '模糊' },
            { label: '希望[向上]', value: '希望' },
            { label: '悬念[谜团]', value: '悬念' },
            { label: '象征[寓意]', value: '象征' },
            { label: '现实[写实]', value: '现实' }
        ];

        const NARRATIVE_PERSPECTIVES = [
            { label: '第一人称[代入感强]', value: '第一人称' },
            { label: '第三人称全知[视角全面]', value: '第三人称全知' },
            { label: '第三人称限制[聚焦特定]', value: '第三人称限制' },
            { label: '多视角[多角度]', value: '多视角' },
            { label: '旁观者[局外人]', value: '旁观者' }
        ];

        const PLOT_STRUCTURES = [
            { id: 1, name: '三幕式结构（Three-Act Structure）', description: '第一幕：设定世界/角色登场/诱因事件\n第二幕：尝试/对抗/中点大事件/转折危机\n第三幕：高潮决战/问题解决/结尾收束' },
            { id: 2, name: '四幕式结构（Four-Act Structure）', description: '第一幕：设定与诱因\n第二幕：初步尝试\n第三幕：危机升级\n第四幕：高潮解决与结尾' },
            { id: 3, name: '五幕结构（Five-Act Structure）', description: '暴露（Exposition）\n上升动作（Rising Action）\n高潮（Climax）\n下降动作（Falling Action）\n结局（Denouement）' }
        ];

        // API 服务
        const generateContent = async (systemPrompt, userPrompt, config) => {
            const safeConfig = config || {};
            const apiKeyToUse = safeConfig?.apiKey?.trim() || "";
            const baseUrl = safeConfig?.baseUrl?.trim() || "https://generativelanguage.googleapis.com";
            
            if (!apiKeyToUse) {
                throw new Error('API密钥不能为空，请检查API配置。');
            }
            
            const textModel = safeConfig?.textModel === 'custom' ? safeConfig.customTextModel || 'gpt-4o' : (safeConfig?.textModel?.trim() || "gemini-2.5-flash");

            const isGemini = baseUrl.includes('generativelanguage.googleapis.com');
            const isClaude = baseUrl.includes('anthropic.com') || safeConfig?.provider === 'claude';
            
            let url = '';
            if (isGemini) {
                url = `${baseUrl}/v1beta/models/${textModel}:generateContent?key=${apiKeyToUse}`;
            } else if (isClaude) {
                let cleanBase = baseUrl.replace(/\/+$/, '');
                if (cleanBase.endsWith('/v1/messages')) {
                    url = cleanBase;
                } else if (cleanBase.endsWith('/v1')) {
                    url = `${cleanBase}/messages`;
                } else {
                    url = `${cleanBase}/v1/messages`;
                }
            } else {
                let cleanBase = baseUrl.replace(/\/+$/, '');
                if (cleanBase.endsWith('/chat/completions')) {
                    url = cleanBase;
                } else if (cleanBase.endsWith('/v1')) {
                    url = `${cleanBase}/chat/completions`;
                } else {
                    url = `${cleanBase}/v1/chat/completions`;
                }
            }

            const body = isGemini
                ? {
                    contents: [{ parts: [{ text: userPrompt }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: {
                        maxOutputTokens: 32768,
                        temperature: 0.7
                    }
                }
                : isClaude
                ? {
                    model: textModel,
                    max_tokens: 32768,
                    temperature: 0.7,
                    messages: [
                        { role: "system", content: systemPrompt },
                        { role: "user", content: userPrompt }
                    ]
                }
                : {
                    model: textModel,
                    max_tokens: 32768,
                    temperature: 0.7,
                    messages: [
                        { role: "system", content: systemPrompt },
                        { role: "user", content: userPrompt }
                    ]
                };

            const headers = { 'Content-Type': 'application/json' };
            if (isGemini) {
                // Gemini API在URL中包含API密钥，不需要Authorization头
            } else if (isClaude) {
                headers['Authorization'] = `Bearer ${apiKeyToUse}`;
                headers['x-api-key'] = apiKeyToUse;
            } else {
                headers['Authorization'] = `Bearer ${apiKeyToUse}`;
            }

            const timeout = 60000;
            const response = await fetch(url, {
                method: 'POST',
                headers,
                body: JSON.stringify(body),
                signal: AbortSignal.timeout(timeout)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`API Error: ${response.status} ${response.statusText} - ${errorText}`);
            }

            const data = await response.json();

            if (isGemini) {
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "No content generated.";
            } else if (isClaude) {
                if (data.content && data.content.length > 0) {
                    const message = data.content[0];
                    if (message.type === 'text') {
                        return message.text || "No content generated.";
                    }
                }
                return "No content generated.";
            } else {
                return data.choices?.[0]?.message?.content || "No content generated.";
            }
        };

        // 自定义弹窗组件
        const CustomAlert = ({ alertState, setAlertState }) => {
            const icons = {
                success: 'CheckCircle2',
                error: 'XCircle',
                warning: 'AlertCircle',
                info: 'Info'
            };

            const colors = {
                success: 'text-emerald-400',
                error: 'text-red-400',
                warning: 'text-amber-400',
                info: 'text-blue-400'
            };

            const bgColors = {
                success: 'bg-emerald-900/30 border-emerald-800/50',
                error: 'bg-red-900/30 border-red-800/50',
                warning: 'bg-amber-900/30 border-amber-800/50',
                info: 'bg-blue-900/30 border-blue-800/50'
            };

            const IconComponent = lucideReact[icons[alertState.type]];

            const handleClose = () => {
                setAlertState(prev => ({
                    ...prev,
                    isOpen: false
                }));
                if (alertState.resolve && alertState.options.cancelText) {
                    alertState.resolve(false);
                }
            };

            const handleConfirm = () => {
                if (alertState.options.onConfirm) {
                    alertState.options.onConfirm();
                }
                if (alertState.resolve) {
                    alertState.resolve(true);
                }
                handleClose();
            };

            const handleCancel = () => {
                if (alertState.options.onCancel) {
                    alertState.options.onCancel();
                }
                if (alertState.resolve) {
                    alertState.resolve(false);
                }
                handleClose();
            };

            if (!alertState.isOpen) return null;

            return React.createElement('div', {
                className: 'fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4 backdrop-blur-sm'
            }, React.createElement('div', {
                className: 'bg-stone-900 border border-stone-800 rounded-xl w-full max-w-md shadow-2xl animate-in fade-in zoom-in-95'
            }, [
                React.createElement('div', { key: 'content', className: 'p-6' }, React.createElement('div', {
                    className: 'flex items-start space-x-4'
                }, [
                    React.createElement('div', {
                        key: 'icon',
                        className: `p-3 rounded-full ${bgColors[alertState.type]}`
                    }, React.createElement(IconComponent, {
                        className: `h-6 w-6 ${colors[alertState.type]}`
                    })),
                    React.createElement('div', { key: 'text', className: 'flex-1' }, [
                        alertState.options.title && React.createElement('h3', {
                            key: 'title',
                            className: 'text-lg font-bold text-white mb-2'
                        }, alertState.options.title),
                        React.createElement('p', {
                            key: 'message',
                            className: 'text-stone-300 whitespace-pre-line'
                        }, alertState.message)
                    ]),
                    !alertState.options.cancelText && React.createElement('button', {
                        key: 'close',
                        onClick: handleClose,
                        className: 'text-stone-500 hover:text-white transition-colors'
                    }, React.createElement(lucideReact.X, { size: 20 }))
                ])),
                (alertState.options.cancelText || alertState.options.confirmText) && React.createElement('div', {
                    key: 'buttons',
                    className: 'flex justify-end space-x-3 p-4 border-t border-stone-800 bg-stone-950/50'
                }, [
                    alertState.options.cancelText && React.createElement('button', {
                        key: 'cancel',
                        onClick: handleCancel,
                        className: 'px-4 py-2 bg-stone-800 hover:bg-stone-700 text-white rounded-lg transition-colors'
                    }, alertState.options.cancelText),
                    React.createElement('button', {
                        key: 'confirm',
                        onClick: handleConfirm,
                        className: `px-4 py-2 text-white rounded-lg transition-colors ${colors[alertState.type]}`,
                        style: {
                            backgroundColor: alertState.type === 'success' ? '#10b981' : 
                                            alertState.type === 'error' ? '#ef4444' :
                                            alertState.type === 'warning' ? '#f59e0b' :
                                            '#3b82f6'
                        }
                    }, alertState.options.confirmText || '确认')
                ])
            ]));
        };

        // 弹窗提供者
        const AlertProvider = ({ children }) => {
            const [alertState, setAlertState] = React.useState({
                message: '',
                type: 'info',
                options: {},
                isOpen: false
            });

            const showAlert = (message, type = 'info', options = {}) => {
                setAlertState({
                    message,
                    type,
                    options: {
                        duration: options.duration || 0,
                        ...options
                    },
                    isOpen: true
                });
            };

            const showConfirm = (message, type = 'warning', options = {}) => {
                return new Promise((resolve) => {
                    setAlertState({
                        message,
                        type,
                        options: {
                            duration: 0,
                            cancelText: '取消',
                            confirmText: '确认',
                            ...options
                        },
                        isOpen: true,
                        resolve
                    });
                });
            };

            const contextValue = { alertState, setAlertState, showAlert, showConfirm };

            return React.createElement(React.Fragment, null, [
                React.createElement(AlertContext.Provider, {
                    key: 'provider',
                    value: contextValue
                }, children),
                React.createElement(CustomAlert, {
                    key: 'alert',
                    alertState,
                    setAlertState
                })
            ]);
        };

        // 创建上下文
        const AlertContext = React.createContext();

        // 使用弹窗的钩子
        const useAlert = () => {
            const context = React.useContext(AlertContext);
            if (context === undefined) {
                throw new Error('useAlert must be used within an AlertProvider');
            }
            return { showAlert: context.showAlert, showConfirm: context.showConfirm };
        };

        // 步骤卡片组件
        const StepCard = ({ title, icon: Icon, isActive, isCompleted, onClick, onShowPrompt }) => {
            return React.createElement('div', {
                onClick,
                className: `flex items-center p-4 rounded-xl cursor-pointer transition-all duration-200 border relative group ${isActive
                    ? 'bg-orange-900/30 border-orange-500 text-orange-100'
                    : isCompleted
                    ? 'bg-stone-800/50 border-amber-900/50 text-amber-400'
                    : 'bg-stone-800/30 border-stone-700 text-stone-500 hover:bg-stone-800'
                }`
            }, [
                React.createElement('div', {
                    key: 'icon',
                    className: `p-2 rounded-lg mr-3 ${isActive ? 'bg-orange-500/20' : 'bg-stone-700/20'}`
                }, Icon ? React.createElement(Icon, { size: 20 }) : React.createElement(lucideReact.Activity, { size: 20 })),
                React.createElement('div', { key: 'content', className: 'flex-1' }, [
                    React.createElement('h3', { key: 'title', className: 'font-semibold text-sm' }, title),
                    isCompleted && React.createElement('span', {
                        key: 'status',
                        className: 'text-xs opacity-70 flex items-center mt-1'
                    }, [React.createElement(lucideReact.Check, { key: 'check', size: 12, className: 'mr-1' }), ' 已生成'])
                ]),
                onShowPrompt && React.createElement('button', {
                    key: 'prompt',
                    onClick: (e) => {
                        e.stopPropagation();
                        onShowPrompt();
                    },
                    className: `p-1.5 rounded-md transition-opacity ${isActive ? 'opacity-100' : 'opacity-0 group-hover:opacity-100'} hover:bg-stone-700 text-stone-400 hover:text-white`,
                    title: "查看提示词"
                }, React.createElement(lucideReact.FileText, { size: 14 })),
                isActive && React.createElement(lucideReact.ChevronRight, {
                    key: 'arrow',
                    size: 16,
                    className: 'text-orange-400 ml-1'
                })
            ]);
        };

        // Markdown 查看器组件
        const MarkdownViewer = ({ content, className = "" }) => {
            const renderMarkdown = (text) => {
                if (!text) return '';
                
                // 简单的Markdown解析
                let html = text
                    .replace(/^### (.+)$/gm, '<h3>$1</h3>')
                    .replace(/^## (.+)$/gm, '<h2>$1</h2>')
                    .replace(/^# (.+)$/gm, '<h1>$1</h1>')
                    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.+?)\*/g, '<em>$1</em>')
                    .replace(/`(.+?)`/g, '<code>$1</code>')
                    .replace(/```([^`]+)```/g, '<pre><code>$1</code></pre>')
                    .replace(/\n\n/g, '</p><p>')
                    .replace(/\n/g, '<br>');
                
                return `<p>${html}</p>`;
            };

            return React.createElement('div', {
                className: `markdown-content bg-stone-900/50 border border-stone-800 rounded-xl p-6 overflow-y-auto max-h-96 custom-scrollbar ${className}`,
                dangerouslySetInnerHTML: { __html: renderMarkdown(content) }
            });
        };

        // 主应用组件
        const App = () => {
            const { showAlert, showConfirm } = useAlert();
            
            const STEPS = [
                { id: 'init', title: '创作初始化', icon: lucideReact.BookOpen },
                { id: 'dna', title: '核心DNA', icon: lucideReact.Activity },
                { id: 'characters', title: '角色动力学', icon: lucideReact.Users },
                { id: 'world', title: '世界观', icon: lucideReact.Globe },
                { id: 'plot', title: '情节架构', icon: lucideReact.GitMerge },
                { id: 'blueprint', title: '章节蓝图', icon: lucideReact.List },
                { id: 'state', title: '角色状态库', icon: lucideReact.Activity },
                { id: 'writing', title: '正文创作', icon: lucideReact.PenTool }
            ];

            const [currentStep, setCurrentStep] = React.useState(0);
            const [inputs, setInputs] = React.useState({
                topic: '',
                genre: '',
                tone: '',
                ending: '',
                perspective: '',
                numberOfChapters: 12,
                wordCount: 2000,
                customRequirements: '',
                novelTitle: ''
            });

            const [apiConfig, setApiConfig] = React.useState({
                provider: 'google',
                baseUrl: 'https://generativelanguage.googleapis.com',
                apiKey: '',
                textModel: 'gemini-2.5-flash'
            });

            const [generatedData, setGeneratedData] = React.useState({
                dna: null,
                globalSummary: null,
                characters: null,
                world: null,
                plot: null,
                blueprint: null,
                state: null,
                chapters: [],
                stateHistory: []
            });

            const [isGenerating, setIsGenerating] = React.useState(false);
            const [loadingMessage, setLoadingMessage] = React.useState("");
            const [showConfigModal, setShowConfigModal] = React.useState(false);

            // 初始化时加载配置
            React.useEffect(() => {
                const savedConfig = localStorage.getItem('deepstory_config');
                if (savedConfig) {
                    try {
                        const parsedConfig = JSON.parse(savedConfig);
                        setApiConfig({
                            provider: parsedConfig.provider || 'google',
                            ...parsedConfig
                        });
                    } catch (e) { console.error("Config load error", e); }
                }
            }, []);

            const handleConfigSave = (config) => {
                setApiConfig(config);
                localStorage.setItem('deepstory_config', JSON.stringify(config));
            };

            const handleGenerate = async (step) => {
                if (!apiConfig.apiKey) {
                    showAlert('请先配置API密钥', 'warning');
                    setShowConfigModal(true);
                    return;
                }

                setIsGenerating(true);
                setLoadingMessage(`正在生成${STEPS[step].title}...`);

                try {
                    // 模拟生成过程
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    // 根据步骤生成不同的内容
                    let content = '';
                    switch (step) {
                        case 0: // 创作初始化
                            content = `## 基础设定 (BASIC_SETTINGS)
- 小说名称：${inputs.novelTitle || '未命名小说'}
- 核心脑洞：${inputs.topic}
- 题材分类：${inputs.genre}
- 叙事视角：${inputs.perspective}
- 故事基调：${inputs.tone}
- 结局倾向：${inputs.ending}
- 预计章节数：${inputs.numberOfChapters}章
- 每章字数：${inputs.wordCount}字
- 自定义特殊要求：${inputs.customRequirements}

## 核心DNA (STORY_DNA)
当${inputs.topic.split('，')[0] || '主角'}遭遇${inputs.topic.split('，')[1] || '核心冲突事件'}，必须${inputs.topic.split('，')[2] || '关键行动选择'}，否则${inputs.topic.split('，')[3] || '具体的灾难后果'}；与此同时，隐藏的更大危机正在悄然发酵。`;
                            break;
                        case 1: // 核心DNA
                            content = `## 核心DNA详细设计
基于您的创作设定，这是一个具有强大潜力的故事框架。核心冲突围绕${inputs.topic}展开，通过${inputs.perspective}视角展现${inputs.tone}的情感基调。`;
                            break;
                        default:
                            content = `这是${STEPS[step].title}的生成内容。基于您的前期设定，这里将展示详细的故事元素。`;
                    }

                    setGeneratedData(prev => ({
                        ...prev,
                        [STEPS[step].id]: content
                    }));

                    showAlert(`${STEPS[step].title}生成成功！`, 'success');
                } catch (error) {
                    console.error('生成失败:', error);
                    showAlert(`生成失败: ${error.message}`, 'error');
                } finally {
                    setIsGenerating(false);
                    setLoadingMessage("");
                }
            };

            const renderStepContent = () => {
                const step = STEPS[currentStep];
                
                switch (step.id) {
                    case 'init':
                        return React.createElement('div', { className: 'space-y-6' }, [
                            React.createElement('h2', { key: 'title', className: 'text-2xl font-bold text-white mb-6' }, '创作初始化'),
                            React.createElement('div', { key: 'form', className: 'grid grid-cols-1 md:grid-cols-2 gap-6' }, [
                                React.createElement('div', { key: 'topic' }, [
                                    React.createElement('label', { className: 'block text-sm font-medium text-stone-400 mb-2' }, '核心脑洞'),
                                    React.createElement('textarea', {
                                        value: inputs.topic,
                                        onChange: (e) => setInputs(prev => ({ ...prev, topic: e.target.value })),
                                        placeholder: '请输入您的核心创意脑洞...',
                                        className: 'w-full bg-stone-900 border border-stone-700 rounded-lg px-4 py-3 text-white placeholder-stone-500 focus:border-orange-500 outline-none',
                                        rows: 3
                                    })
                                ]),
                                React.createElement('div', { key: 'genre' }, [
                                    React.createElement('label', { className: 'block text-sm font-medium text-stone-400 mb-2' }, '题材分类'),
                                    React.createElement('select', {
                                        value: inputs.genre,
                                        onChange: (e) => setInputs(prev => ({ ...prev, genre: e.target.value })),
                                        className: 'w-full bg-stone-900 border border-stone-700 rounded-lg px-4 py-3 text-white focus:border-orange-500 outline-none'
                                    }, [
                                        React.createElement('option', { key: 'default', value: '' }, '选择题材'),
                                        ...TAGS.male.map(tag => React.createElement('option', { key: tag, value: tag }, tag))
                                    ])
                                ]),
                                React.createElement('div', { key: 'novelTitle' }, [
                                    React.createElement('label', { className: 'block text-sm font-medium text-stone-400 mb-2' }, '小说名称'),
                                    React.createElement('input', {
                                        type: 'text',
                                        value: inputs.novelTitle,
                                        onChange: (e) => setInputs(prev => ({ ...prev, novelTitle: e.target.value })),
                                        placeholder: '请输入小说名称...',
                                        className: 'w-full bg-stone-900 border border-stone-700 rounded-lg px-4 py-3 text-white placeholder-stone-500 focus:border-orange-500 outline-none'
                                    })
                                ]),
                                React.createElement('div', { key: 'tone' }, [
                                    React.createElement('label', { className: 'block text-sm font-medium text-stone-400 mb-2' }, '故事基调'),
                                    React.createElement('select', {
                                        value: inputs.tone,
                                        onChange: (e) => setInputs(prev => ({ ...prev, tone: e.target.value })),
                                        className: 'w-full bg-stone-900 border border-stone-700 rounded-lg px-4 py-3 text-white focus:border-orange-500 outline-none'
                                    }, [
                                        React.createElement('option', { key: 'default', value: '' }, '选择基调'),
                                        ...STORY_TONES.map(tone => React.createElement('option', { key: tone.value, value: tone.value }, tone.label))
                                    ])
                                ])
                            ]),
                            React.createElement('button', {
                                key: 'generate',
                                onClick: () => handleGenerate(currentStep),
                                disabled: isGenerating || !inputs.topic || !inputs.genre,
                                className: `w-full py-3 px-6 rounded-lg font-semibold transition-all ${isGenerating || !inputs.topic || !inputs.genre
                                    ? 'bg-stone-700 text-stone-400 cursor-not-allowed'
                                    : 'bg-orange-600 hover:bg-orange-500 text-white shadow-lg shadow-orange-900/20'
                                }`
                            }, isGenerating ? [
                                React.createElement('div', { key: 'spinner', className: 'loading-spinner inline-block mr-2' }),
                                '生成中...'
                            ] : '开始创作初始化')
                        ]);

                    default:
                        const content = generatedData[step.id];
                        return React.createElement('div', { className: 'space-y-6' }, [
                            React.createElement('h2', { key: 'title', className: 'text-2xl font-bold text-white mb-6' }, step.title),
                            content ? React.createElement(MarkdownViewer, {
                                key: 'content',
                                content: content,
                                className: 'min-h-64'
                            }) : React.createElement('div', {
                                key: 'empty',
                                className: 'text-center py-12 text-stone-500'
                            }, '暂无内容，请先生成此步骤的内容'),
                            React.createElement('button', {
                                key: 'generate',
                                onClick: () => handleGenerate(currentStep),
                                disabled: isGenerating,
                                className: `w-full py-3 px-6 rounded-lg font-semibold transition-all ${isGenerating
                                    ? 'bg-stone-700 text-stone-400 cursor-not-allowed'
                                    : 'bg-orange-600 hover:bg-orange-500 text-white shadow-lg shadow-orange-900/20'
                                }`
                            }, isGenerating ? [
                                React.createElement('div', { key: 'spinner', className: 'loading-spinner inline-block mr-2' }),
                                '生成中...'
                            ] : `生成${step.title}`)
                        ]);
                }
            };

            // 配置模态框组件
            const ConfigModal = () => {
                const [localConfig, setLocalConfig] = React.useState(apiConfig);

                const handleSave = () => {
                    handleConfigSave(localConfig);
                    setShowConfigModal(false);
                    showAlert('配置保存成功', 'success');
                };

                if (!showConfigModal) return null;

                return React.createElement('div', {
                    className: 'fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4 backdrop-blur-sm'
                }, React.createElement('div', {
                    className: 'bg-stone-900 border border-stone-800 rounded-xl w-full max-w-2xl shadow-2xl animate-in fade-in zoom-in-95'
                }, [
                    React.createElement('div', { key: 'header', className: 'p-6 border-b border-stone-800' }, [
                        React.createElement('h2', {
                            key: 'title',
                            className: 'text-xl font-bold text-white'
                        }, 'API配置'),
                        React.createElement('p', {
                            key: 'description',
                            className: 'text-stone-400 text-sm mt-1'
                        }, '配置AI模型API参数')
                    ]),
                    React.createElement('div', { key: 'content', className: 'p-6 space-y-4' }, [
                        React.createElement('div', { key: 'provider' }, [
                            React.createElement('label', { className: 'block text-sm font-medium text-stone-400 mb-2' }, '服务提供商'),
                            React.createElement('select', {
                                value: localConfig.provider,
                                onChange: (e) => setLocalConfig(prev => ({ ...prev, provider: e.target.value })),
                                className: 'w-full bg-stone-800 border border-stone-700 rounded-lg px-4 py-2 text-white focus:border-orange-500 outline-none'
                            }, [
                                React.createElement('option', { key: 'google', value: 'google' }, 'Google Gemini'),
                                React.createElement('option', { key: 'openai', value: 'openai' }, 'OpenAI'),
                                React.createElement('option', { key: 'claude', value: 'claude' }, 'Claude')
                            ])
                        ]),
                        React.createElement('div', { key: 'apiKey' }, [
                            React.createElement('label', { className: 'block text-sm font-medium text-stone-400 mb-2' }, 'API密钥'),
                            React.createElement('input', {
                                type: 'password',
                                value: localConfig.apiKey,
                                onChange: (e) => setLocalConfig(prev => ({ ...prev, apiKey: e.target.value })),
                                placeholder: '请输入您的API密钥...',
                                className: 'w-full bg-stone-800 border border-stone-700 rounded-lg px-4 py-2 text-white placeholder-stone-500 focus:border-orange-500 outline-none'
                            })
                        ]),
                        React.createElement('div', { key: 'baseUrl' }, [
                            React.createElement('label', { className: 'block text-sm font-medium text-stone-400 mb-2' }, 'API地址'),
                            React.createElement('input', {
                                type: 'text',
                                value: localConfig.baseUrl,
                                onChange: (e) => setLocalConfig(prev => ({ ...prev, baseUrl: e.target.value })),
                                placeholder: '请输入API地址...',
                                className: 'w-full bg-stone-800 border border-stone-700 rounded-lg px-4 py-2 text-white placeholder-stone-500 focus:border-orange-500 outline-none'
                            })
                        ]),
                        React.createElement('div', { key: 'model' }, [
                            React.createElement('label', { className: 'block text-sm font-medium text-stone-400 mb-2' }, '文本模型'),
                            React.createElement('select', {
                                value: localConfig.textModel,
                                onChange: (e) => setLocalConfig(prev => ({ ...prev, textModel: e.target.value })),
                                className: 'w-full bg-stone-800 border border-stone-700 rounded-lg px-4 py-2 text-white focus:border-orange-500 outline-none'
                            }, [
                                React.createElement('option', { key: 'gemini', value: 'gemini-2.5-flash' }, 'Gemini 2.5 Flash'),
                                React.createElement('option', { key: 'gpt4o', value: 'gpt-4o' }, 'GPT-4o'),
                                React.createElement('option', { key: 'claude', value: 'claude-3-5-sonnet-20241022' }, 'Claude 3.5 Sonnet')
                            ])
                        ])
                    ])),
                    React.createElement('div', {
                        key: 'footer',
                        className: 'flex justify-end space-x-3 p-6 border-t border-stone-800 bg-stone-950/50'
                    }, [
                        React.createElement('button', {
                            key: 'cancel',
                            onClick: () => setShowConfigModal(false),
                            className: 'px-4 py-2 bg-stone-800 hover:bg-stone-700 text-white rounded-lg transition-colors'
                        }, '取消'),
                        React.createElement('button', {
                            key: 'save',
                            onClick: handleSave,
                            className: 'px-4 py-2 bg-orange-600 hover:bg-orange-500 text-white rounded-lg transition-colors'
                        }, '保存配置')
                    ])
                ]));
            };

            return React.createElement('div', { className: 'min-h-screen bg-stone-950' }, [
                React.createElement('div', {
                    key: 'header',
                    className: 'bg-stone-900/80 backdrop-blur-sm border-b border-stone-800 sticky top-0 z-40'
                }, React.createElement('div', {
                    className: 'max-w-7xl mx-auto px-4 sm:px-6 lg:px-8'
                }, React.createElement('div', {
                    className: 'flex items-center justify-between h-16'
                }, [
                    React.createElement('div', { key: 'logo', className: 'flex items-center space-x-3' }, [
                        React.createElement(lucideReact.BookOpen, {
                            key: 'icon',
                            className: 'h-8 w-8 text-orange-500'
                        }),
                        React.createElement('h1', {
                            key: 'title',
                            className: 'text-xl font-bold text-white'
                        }, 'DeepStory AI')
                    ]),
                    React.createElement('button', {
                        key: 'config',
                        onClick: () => setShowConfigModal(true),
                        className: 'flex items-center space-x-2 bg-stone-800 hover:bg-stone-700 text-stone-300 px-4 py-2 rounded-lg transition-colors'
                    }, [
                        React.createElement(lucideReact.Settings, { key: 'icon', size: 16 }),
                        React.createElement('span', { key: 'text' }, 'API配置')
                    ])
                ]))),

                React.createElement('div', {
                    key: 'main',
                    className: 'max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8'
                }, React.createElement('div', {
                    className: 'grid grid-cols-1 lg:grid-cols-4 gap-8'
                }, [
                    React.createElement('div', {
                        key: 'sidebar',
                        className: 'lg:col-span-1 space-y-4'
                    }, STEPS.map((step, index) => React.createElement(StepCard, {
                        key: step.id,
                        title: step.title,
                        icon: step.icon,
                        isActive: currentStep === index,
                        isCompleted: !!generatedData[step.id],
                        onClick: () => setCurrentStep(index),
                        onShowPrompt: () => showAlert(`这是${step.title}的提示词模板`, 'info')
                    }))),

                    React.createElement('div', {
                        key: 'content',
                        className: 'lg:col-span-3'
                    }, [
                        isGenerating && React.createElement('div', {
                            key: 'loading',
                            className: 'fixed inset-0 bg-black/50 flex items-center justify-center z-50'
                        }, React.createElement('div', {
                            className: 'bg-stone-900 border border-stone-800 rounded-xl p-6 shadow-2xl'
                        }, [
                            React.createElement('div', {
                                key: 'spinner',
                                className: 'loading-spinner mx-auto mb-4'
                            }),
                            React.createElement('p', {
                                key: 'message',
                                className: 'text-white text-center'
                            }, loadingMessage)
                        ])),

                        renderStepContent(),

                        React.createElement('div', {
                            key: 'navigation',
                            className: 'flex justify-between mt-8'
                        }, [
                            React.createElement('button', {
                                key: 'prev',
                                onClick: () => setCurrentStep(Math.max(0, currentStep - 1)),
                                disabled: currentStep === 0,
                                className: `px-6 py-2 rounded-lg transition-colors ${currentStep === 0
                                    ? 'bg-stone-800 text-stone-500 cursor-not-allowed'
                                    : 'bg-stone-700 hover:bg-stone-600 text-white'
                                }`
                            }, '上一步'),
                            React.createElement('button', {
                                key: 'next',
                                onClick: () => setCurrentStep(Math.min(STEPS.length - 1, currentStep + 1)),
                                disabled: currentStep === STEPS.length - 1,
                                className: `px-6 py-2 rounded-lg transition-colors ${currentStep === STEPS.length - 1
                                    ? 'bg-stone-800 text-stone-500 cursor-not-allowed'
                                    : 'bg-orange-600 hover:bg-orange-500 text-white'
                                }`
                            }, '下一步')
                        ])
                    ])
                ])),

                React.createElement(ConfigModal, { key: 'config-modal' })
            ]);
        };

        // 渲染应用
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(React.StrictMode, null, 
            React.createElement(AlertProvider, null, 
                React.createElement(App, null)
            )
        ));
    </script>
</body>
</html>